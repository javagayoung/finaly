<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"  %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>

<style>
.chart1 {
	height: 100%;
	width: 20%;
}

.chart2 {
	height: 100%;
	width: 60%;
}

.chart3 {
	height: 48.5%;
	width: 100%;
}

.chart4 {
	margin-top: 6%;
	height: 48.5%;
	width: 100%;
}

.chart-wrap {
	height: 100%;
	width: 20%;
}

.div-info-top {
	margin-top: 10%;
	display:flex;
	justify-content: space-around;
	color: #F8F9FC;
}

.div-info {
	display:flex;
	justify-content: space-around;
}

.div-info:hover {
	background-color: #EDF8F9;
}

.div-info p {
	margin-top:3%;
	margin-bottom:3%;
}

.info1 {
	width: 40px;
}

.info2 {
	width: 120px;
}

.info3 {
	width: 100px;
}

.selected {
    background-color: #EDF8F9;
}

.myhr {
	width: 954px;
	height: 1px;
	flex-shrink: 0;
	background: #EBEFF0;
	margin-left: -24px;
}

.aside-ams-patient{
	width: 196px;
	border-radius: 16px 0px 0px 16px;
	background: var(--bg-02, #DBF2F4);
	height: 56px;
	border-right: 4px solid var(--ci-01, #0ABAB5);
	margin-left: 4px;
	color: var(--ci-01, #0ABAB5);
}

.patient-detail {
	width: 892px;
	height: 100%;
	flex-shrink: 0;
}	
.patient-note {
	width: 360px;
}

.search{
	background-image: url(/resources/images/Search.png);
	background-repeat: no-repeat;
	background-position: 252px center;
	width: 292px;
	height: 48px;
}

.record-input{
	background-image: url(/resources/images/Arrowupward.png);
	background-repeat: no-repeat;
	background-position: 272px center;
	width: 312px;
	height: 48px;
}

.dduk-vertical-line {
	height: 642px;
	margin-top: -18px;
	margin-left: 272px;
}

hr{
	margin: -8px 0 16px -16px;
	background: var(--border, #EBEFF0);
	height: 1px;
}

.record-content-fr {
	height: 343px;
}
</style>

<div class="dduk-body-border patient-list">
		<div>
			<div class="dduk-title-area">
				<h2>대기환자 목록</h2>
			</div>
			<div class="dduk-x-pd8">
				<table class="patient-list-table" id="waitingQueue">
					<tr class="tr-padding">
						<th class="td-padding gray-text" style="width:40px;">No</th>
						<th class="td-padding gray-text paName" style="width:120px;">이름</th>
						<th class="td-padding gray-text">생년월일</th>
					</tr>
					
				</table>
			</div>	
		</div>
	</div>
	
	<div class="dduk-body-border patient-detail"  style="position: relative;">
		<div class="dduk-title-area">
			<div class="d-flex align-items-center">
				<h2>노르망디 크롱스 블레이드</h2>
				<span class="gray-text mar-b-8 mar-l-8">남, 39세(1983-12-05)</span>
			</div>
			<div>
				<div class="d-flex patient-info">
					<div>
						<span class="gray-text">신장&nbsp;&nbsp;</span>180.6cm
					</div>
					<div>
						<span class="gray-text">체중&nbsp;&nbsp;</span>78.8kg
					</div>
					<div>
						<span class="gray-text">체온&nbsp;&nbsp;</span>36.8°C</div>
					</div>
			</div>
			<button class="dduk-btn-normal">상세보기</button>
		</div>
		<hr style="width: 892px;">
		<div class="d-flex">
			<div class="dduk-history">
				<div style="height: 520px;">
					<div class="subTitle-margin">
						<h3>진료 이력</h3>
					</div>
					<div class="history-scroll">
						<div class="dduk-history-list">
							<div class="history-array">	
								<div>
									<div class="history-title">내원·2023-11-22(수)</div>
									<div>담당의 이은솔</div>
								</div>
								<button class="dduk-btn-active" style="height: 32px;"> 
									수납필요
								</button>
							</div>
							<div class="d-flex history-btn-list">
								<span class="history-btn">진료</span>
								<span class="history-btn">검사</span>
								<span class="history-btn">치료</span>
								<span class="history-btn">처방</span>
							</div>
						</div>
						<div class="dduk-history-list">
							<div class="history-array">	
								<div>
									<div class="history-title">내원·2023-11-22(수)</div>
									<div>담당의 이은솔</div>
								</div>
								<button class="dduk-btn-active" style="height: 32px;"> 
									수납필요
								</button>
							</div>
							<div class="d-flex history-btn-list">
								<span class="history-btn">진료</span>
								<span class="history-btn">검사</span>
								<span class="history-btn">치료</span>
								<span class="history-btn">처방</span>
							</div>
						</div>
						<div class="dduk-history-list">
							<div class="history-array">	
								<div>
									<div class="history-title">내원·2023-11-22(수)</div>
									<div>담당의 이은솔</div>
								</div>
								<button class="dduk-btn-active" style="height: 32px;"> 
									수납필요
								</button>
							</div>
							<div class="d-flex history-btn-list">
								<span class="history-btn">진료</span>
								<span class="history-btn">검사</span>
								<span class="history-btn">치료</span>
								<span class="history-btn">처방</span>
							</div>
						</div>
						<div class="dduk-history-list">
							<div class="history-array">	
								<div>
									<div class="history-title">내원·2023-11-22(수)</div>
									<div>담당의 이은솔</div>
								</div>
								<button class="dduk-btn-active" style="height: 32px;"> 
									수납필요
								</button>
							</div>
							<div class="d-flex history-btn-list">
								<span class="history-btn">진료</span>
								<span class="history-btn">검사</span>
								<span class="history-btn">치료</span>
								<span class="history-btn">처방</span>
							</div>
						</div>
					</div>
				</div>
				<hr style="width: 289px;">
				<div style="height: 239px;">
					<div class="spa-betw">
						<div class="subTitle-margin">
							<h3>문서 발급</h3>
						</div>
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
							<g clip-path="url(#clip0_142_1806)">
							<path d="M18 13H13V18C13 18.55 12.55 19 12 19C11.45 19 11 18.55 11 18V13H6C5.45 13 5 12.55 5 12C5 11.45 5.45 11 6 11H11V6C11 5.45 11.45 5 12 5C12.55 5 13 5.45 13 6V11H18C18.55 11 19 11.45 19 12C19 12.55 18.55 13 18 13Z" fill="#8D9EA5"/>
							</g>
							<defs>
							<clipPath id="clip0_142_1806">
							<rect width="24" height="24" fill="white"/>
							</clipPath>
							</defs>
						</svg>
					</div>
					<div class="gap-ver-16 p-8">
						<div class="spa-betw"><span class="text16">진단서</span><button class="dduk-btn-normal">발급하기</button></div>
						<div class="spa-betw"><span class="text16">소견서</span><button class="dduk-btn-disabled">발급완료</button></div>
						<div class="spa-betw"><span class="text16">처방전</span><button class="dduk-btn-danger">발급불가</button></div>
					</div>
				</div>
			</div>
			<div class="patient-record">
				<div class="subTitle-margin">
					<h3>진료 기록</h3>
				</div>
				<div class="gap-ver-16">
					<div class="gap-row-16 w-100">
						<div class="dduk-inner-border record-content-fr" style="width:284px;">
							<h3 class="m-8">진료 내용</h3>
						</div>
						<div class="dduk-inner-border record-content-fr" style="width:272px;">
							<h3 class="m-8">이미지</h3>
							<div class="record-img-scroll">
									<img class="record-img" src="/resources/images/images1.png"/>
									<img class="record-img" src="/resources/images/images1.png"/>
									<img class="record-img" src="/resources/images/images1.png"/>
									<img class="record-img" src="/resources/images/images1.png"/>
									<img class="record-img" src="/resources/images/images1.png"/>
									<img class="record-img" src="/resources/images/images1.png"/>
							</div>
						</div>
					</div>
					<div class="dduk-inner-border w-100" style="height: 320px;">
						<h3>오더 내역 </h3>
					</div>
				</div>
			</div>
		</div>
		
	</div>
	
	<div class="dduk-body-border patient-note">
		<div class="subTitle-margin mar-b-8">
			<h3>환자 기록</h3>
		</div>
		<div class="spa-betw flex-d-col" style="height: 760px;">
			<div class="gap-ver-32 w-100 p-8">
				<div>
					<div class="d-flex">
						<img class="record-profile-img" src="/resources/images/Ellipse12.png"/>
						<div>
							<div>원무과 김한나</div>
							<div class="gray-text">2023-11-21(화) 12:33:42</div>
						</div>
					</div>
					<div class="d-flex justify-content-end">
						<div class="patient-record-chat mar-t-8">
							상시 복용 약품 없음 확인.
						</div>
					</div>
				</div>
				<div>
					<div class="d-flex">
						<img class="record-profile-img" src="/resources/images/Ellipse14.png"/>
						<div>
							<div>의사 전영균</div>
							<div class="gray-text">2023-11-21(화) 16:55:16</div>
						</div>
					</div>
					<div class="d-flex justify-content-end">
						<div class="patient-record-chat mar-t-8">
							진단서 발급, <br/>
							금주 금요일에 예약 잡아주세요.
						</div>
					</div>
				</div>
				<div>
					<div class="d-flex">
						<img class="record-profile-img" src="/resources/images/Ellipse13.png"/>
						<div>
							<div>원무과 이수정</div>
							<div class="gray-text">2023-11-21(화) 16:55:16</div>
						</div>
					</div>
					<div class="d-flex justify-content-end">
						<div class="patient-record-chat mar-t-8">
							샤이니 콘서트 예약 바랍니다.
						</div>
					</div>
				</div>
			<hr style="width:360px; margin-left: -24px;">
			<div class="gray-text" style="margin-top: -44px;
    margin-left: 102px;">2023-11-2(수)</div>
			</div>
			<input class="record-input dduck-input" placeholder="환자 기록을 추가해주세요">
		</div>
	</div>

<script>
$(function(){
	
	// 최초 1번 대기목록 갱신
	// 굳이 Ajax를 이용해 동적으로 추가하는 이유는 Websocket을 이용해 실시간으로 대기 환자 갱신을 위해
	loadReceptionList();
	
	
	// 대기환자 클릭시 이벤트
	$(document).on("click", ".tr-paInfo", function() {
		
		// 1. 환자의 진료를 시작할건지 물어본다
		Swal.fire({
		  title: '진료를 시작하시겠습니까???',
		  icon: 'warning',
		  showCancelButton: true,
		  confirmButtonColor: '#3085d6',
		  cancelButtonColor: '#d33',
		  confirmButtonText: '확인',
		  cancelButtonText: '취소'
		}).then((result) => {
		  if (result.value) {
              return;
		  }
		})
		
		console.log("취소하면안보임");
		
        // 이전에 선택된 요소의 클래스 초기화
        $(".tr-paInfo").removeClass("selected");
        // 현재 클릭한 요소에 select클래스 추가
        $(this).addClass("selected");
    });
	
	
	// 환자 대기목록 갱신
	function loadReceptionList(){
		$.ajax({
			url: '/reception/getReceptionList',
			dataType: 'json',
			type: 'post',
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success: function(rst){
				console.log("rst", rst);
				
				$.each(rst, function(index){
					let paInfo = "";
					paInfo += '<tr class="tr-padding tr-paInfo">';
					paInfo += '<td class="td-padding">'+(index + 1)+'</td>';
					paInfo += '<td height="48px" class="td-padding">'+truncateText(rst[index].paName,7)+'</td>';
					paInfo += '<td class="td-padding">'+ formatResidentNumber(rst[index].paReg) +'</td>';
					paInfo += '</tr>';
					
					$('#waitingQueue').append(paInfo);
				});
			},
			error: function(xhr, status, error){
				console.log('Error:', xhr, status, error);
			}
		});
	}
	
	
	// 주민번호를 생년월일로 변환
	function formatResidentNumber(residentNumber) {
		
		// 00~39년생은 20을 붙이고 그 외엔 19를 붙인다
	    let year = "";
	    if(Number(residentNumber.substr(0,1)) <= 3){
	    	year += "20";
	    } else {
	    	year += "19";
	    }
	    year += residentNumber.substr(0,2);
	    
	    
	    let month = residentNumber.substr(2,2);
	    let day = residentNumber.substr(4,2);
	    
	    let birthDay = year + "-" + month + "-" + day;
	    return birthDay;
	}
	
	
	// 이름 등이 글자를 제어하고 싶을 때 maxLength까지만 표시
	function truncateText(text, maxLength) {
		if (text.length > maxLength) {
			return text.slice(0, maxLength) + '...';
		} else {
		    return text;
		}
	}
});
</script>